# 项目上下文文档

## 项目概述

这是一个基于 Hexo 的静态博客项目，主要包含从微信公众号迁移过来的文章。

- **项目路径**: `E:\3.github\repositories\dadongshangu.github.io`
- **博客目录**: `blog/`
- **文章目录**: `blog/source/_posts/`
- **迁移脚本目录**: `blog/migration/scripts/`

## 项目结构

```
dadongshangu.github.io/
├── blog/                          # Hexo 博客主目录
│   ├── source/
│   │   └── _posts/               # Markdown 文章目录（39篇文章）
│   ├── migration/                # 迁移相关文件
│   │   ├── data/                 # 原始数据
│   │   │   ├── articles_list.json    # 文章列表（包含URL）
│   │   │   └── wechatsync_md/   # 原始Markdown文件
│   │   └── scripts/              # 修复脚本
│   │       ├── fix_paragraphs.py          # 段落修复脚本
│   │       ├── clean_duplicate_captions.py # 清理重复图片说明
│   │       ├── fix_duplicate_content.py    # 清理重复内容
│   │       ├── add_end_marker.py           # 添加文章结束标记
│   │       ├── comprehensive_fix.py         # 综合修复脚本
│   │       ├── restore_missing_content.py  # 恢复缺失内容
│   │       └── smart_insert_images.py     # 智能图片插入
│   └── themes/                   # Hexo 主题
└── CONTEXT.md                    # 本文档
```

## 已解决的问题

### 1. 图片插入和匹配问题
- **问题**: 文章中有图片说明但缺少对应的图片
- **解决方案**: 
  - 创建了 `smart_insert_images.py` 脚本
  - 从微信公众号HTML中提取图片
  - 根据上下文智能匹配图片和图片说明
  - 过滤小图片（分隔符、装饰图）
- **状态**: ✅ 已完成

### 2. 重复图片说明问题
- **问题**: 文章中有大量重复的图片说明（如"唯有母爱不可辜负"文章）
- **解决方案**: 
  - 创建了 `clean_duplicate_captions.py` 脚本
  - 只保留紧跟在图片后面的图片说明
  - 删除没有对应图片的图片说明
- **状态**: ✅ 已完成

### 3. 段落分隔问题
- **问题**: 文章段落混乱，长段落没有分段，对话被合并
- **解决方案**: 
  - 创建了 `fix_paragraphs.py` 脚本
  - 在句号、问号、感叹号后添加段落分隔
  - 识别独立对话行并正确分段
- **状态**: ✅ 已完成

### 4. 重复内容问题
- **问题**: 文章中有大量重复段落（如"忆二十几年前的"大案""文章）
- **解决方案**: 
  - 创建了 `fix_duplicate_content.py` 脚本
  - 删除重复段落
  - 清理分隔符（dadong*shangu等）
- **状态**: ✅ 已完成

### 5. 文章末尾图片标记
- **问题**: 文章末尾有图片堆积，需要标记文章结束位置
- **解决方案**: 
  - 创建了 `add_end_marker.py` 脚本
  - 在末尾图片前添加"全文完，以下图片待整理"标记
- **状态**: ✅ 已完成

### 6. 文字内容缺失问题
- **问题**: 部分文章只有图片，没有文字内容（如"一个异乡人眼中的宁国"）
- **解决方案**: 
  - 创建了 `restore_missing_content.py` 脚本
  - 从原始数据源恢复文字内容
- **状态**: ✅ 已完成

### 7. 分段混乱问题
- **问题**: 长段落没有分段，对话被合并（如"第一次摆摊"文章）
- **解决方案**: 
  - 手动修复长段落分段
  - 改进段落修复脚本
- **状态**: ✅ 已完成

## 重要脚本说明

### fix_paragraphs.py
- **功能**: 修复段落分隔
- **特点**: 
  - 识别独立对话行
  - 在标点符号后添加段落分隔
  - 保留特殊格式（列表、引用、图片等）

### clean_duplicate_captions.py
- **功能**: 清理重复的图片说明
- **特点**: 
  - 只保留紧跟在图片后面的图片说明
  - 删除没有对应图片的图片说明
  - 跳过连续重复的图片说明

### fix_duplicate_content.py
- **功能**: 清理重复内容和分隔符
- **特点**: 
  - 删除重复段落
  - 清理分隔符（dadong*shangu等）
  - 清理多余空行

### comprehensive_fix.py
- **功能**: 综合修复脚本
- **特点**: 
  - 检查文章是否有文字内容
  - 清理重复的图片说明
  - 修复段落分隔
  - 清理多余空行

### smart_insert_images.py
- **功能**: 智能图片插入
- **特点**: 
  - 检查哪些文章有图片说明但缺少图片
  - 从HTML中提取图片
  - 根据上下文匹配图片和图片说明
  - 在正确位置插入图片，不破坏段落结构

### add_end_marker.py
- **功能**: 在文章末尾图片前添加结束标记
- **特点**: 
  - 检测文章末尾的图片（最后30行内）
  - 在第一个图片前插入"全文完，以下图片待整理"
  - 避免重复添加

## 文章格式规范

### Front-matter
```yaml
---
title: 文章标题
date: YYYY-MM-DD 00:00:00
tags:
  - 大东山谷精选
---
```

### 图片格式
- 标准格式: `![图片说明](图片URL)`
- 图片说明格式: `（图片说明）` 或 `_（图片说明）_`
- 图片说明应紧跟在图片后面

### 段落分隔
- 在句号、问号、感叹号、冒号后添加段落分隔（空行）
- 独立对话行应单独成段
- 保留特殊格式（列表、引用、图片等）

### 文章结束标记
- 在文章末尾图片前添加: `全文完，以下图片待整理`

## 常见问题处理

### 1. 图片说明重复
- **检查**: 使用 `clean_duplicate_captions.py`
- **修复**: 只保留紧跟在图片后面的图片说明

### 2. 段落混乱
- **检查**: 使用 `fix_paragraphs.py`
- **修复**: 在标点符号后添加段落分隔

### 3. 重复内容
- **检查**: 使用 `fix_duplicate_content.py`
- **修复**: 删除重复段落和分隔符

### 4. 缺少文字内容
- **检查**: 使用 `comprehensive_fix.py`
- **修复**: 从原始数据源恢复内容

### 5. 长段落未分段
- **检查**: 手动检查文章
- **修复**: 在句号、问号、感叹号后添加分段

## 数据源

### articles_list.json
- **位置**: `blog/migration/data/articles_list.json`
- **内容**: 文章列表，包含标题、URL、时间戳
- **用途**: 用于匹配文章和获取HTML内容

### wechatsync_md/
- **位置**: `blog/migration/data/wechatsync_md/`
- **内容**: 原始Markdown文件
- **用途**: 用于恢复缺失的文字内容

## 注意事项

1. **图片过滤**: 小图片（<200x200）通常被过滤，可能是分隔符或装饰图
2. **段落分隔**: 不要过度添加段落分隔，保持自然阅读节奏
3. **图片说明**: 只保留有对应图片的图片说明
4. **重复内容**: 检查文章是否有重复段落，及时清理
5. **文字内容**: 确保每篇文章都有足够的文字内容（>50字符）

## 待办事项

- [ ] 检查所有文章的图片是否正确插入
- [ ] 验证所有文章的段落分隔是否正确
- [ ] 确认没有重复内容和图片说明
- [ ] 检查文章末尾标记是否正确

## 更新记录

- 2025-01-XX: 创建项目上下文文档
- 2025-01-XX: 完成图片插入和匹配功能
- 2025-01-XX: 完成段落修复功能
- 2025-01-XX: 完成重复内容清理功能
- 2025-01-XX: 完成文章结束标记添加功能
- 2025-01-XX: 完成缺失内容恢复功能
